{% extends 'communities/base.html' %}

{% block title %}{{ community.name }} - Portal UNITED {% endblock %}

{% block content %}
    <div class="row">
        <!-- Lewa kolumna - Zdjƒôcie i podstawowe info -->
        <div class="col-md-8">

            <!-- Zdjƒôcie g≈Ç√≥wne -->
            {% if community.photo_url %}
            <img src="{{ community.photo_url }}" class="img-fluid rounded mb-4" alt="{{ community.name }}">
            {% endif %}

            <!-- Nazwa i opis -->
            <h1>{{ community.name }}</h1>
            <p class="lead">{{ community.description }}</p>

            <!-- Tagi -->
            <div class="mb-3">
                {% for tag in community.tags.all %}
                <span class="badge bg-primary">{{ tag.name }}</span>
                {% endfor %}
            </div>
            
            
            <hr>

            <!-- Pe≈Çny opis -->
            <h3>O wsp√≥lnocie</h3>
            <p>{{ community.full_description|default:"Brak szczeg√≥≈Çowego opisu." }}</p>
            
            <!-- Cz≈Çonkowie -->
            <h3 class="mt-4">Cz≈Çonkowie ({{ members.count }})</h3>


            {% if members %}
            <div class="row">
            <!-- <ul class="list-group"> -->
                {% for membership in members %}
                <!-- <li class="list-group-item"> -->
                <div class="col-md-6 mb-3">
                    <div class="d-flex align-items-center">
                        <div class="rounded-circle bg-secondary text-white d-flex align-items-center justify-content-center me-3"
                            style="width: 50px; height: 50px; font-size: 20px;">
                            {{ membership.person.person_profile.first_name|first|upper }}
                        </div>
                        <div>
                            <strong>{{ membership.person.person_profile.first_name }} {{ membership.person.person_profile.last_name }}</strong>
                            {% if membership.role != 'member' %}
                            <br>
                            <span class="badge 
                                {% if membership.role == 'owner' %}bg-warning text-dark
                                {% elif membership.role == 'admin' %}bg-info
                                {% elif membership.role in 'leader,service_leader' %}bg-success
                                {% endif %}">
                                {{ membership.get_role_display }}
                            </span>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% else %}
            <p class="text-muted">Brak cz≈Çonk√≥w do wy≈õwietlenia.</p>
            {% endif %}
        </div>

        <!-- Prawa kolumna - Sidebar z info i akcjami -->
        
        <div class="col-md-4">

            <!-- Logo -->
            {% if community.logo_url %}
            <div class="text-center mb-4">
                <img src="{{ community.logo_url }}" 
                    alt="Logo {{ community.name }}"
                    class="img-fluid"
                    style="max-height: 150px;">
            </div>
            {% endif %}

            <!-- Karta z informacjami -->
            <div class="card">
                <!-- <div class="card-body">
                    <h5 class="card-title">Informacje</h5>
                    <p><strong>Miasto:</strong> {{ community.city }}</p>
                    {% if community.parish %}
                    <p><strong>Parafia:</strong> {{ community.parish }}</p>
                    {% endif %}
                    {% if community.denomination %}
                    <p><strong>Denominacja:</strong> {{ community.get_denomination_display }}</p>
                    {% endif %}
                    {% if community.contact_email %}
                    <p><strong>Email:</strong> <a href="mailto:{{ community.contact_email }}">{{ community.contact_email }}</a></p>
                    {% endif %}
                    {% if community.website %}
                    <p><strong>Strona WWW:</strong> <a href="{{ community.website }}" target="_blank">Odwied≈∫</a></p>
                    {% endif %}
                </div> -->
                <div class="card-body">
                    <h5 class="card-title">Informacje</h5>
                    
                    <ul class="list-unstyled">
                        <li class="mb-2">
                            <strong>üìç Miasto:</strong> {{ community.city }}
                        </li>
                        
                        {% if community.parish %}
                        <li class="mb-2">
                            <strong>‚õ™ Parafia:</strong> {{ community.parish }}
                        </li>
                        {% endif %}
                        
                        {% if community.denomination %}
                        <li class="mb-2">
                            <strong>‚úùÔ∏è Denominacja:</strong> 
                            {{ community.get_denomination_display }}
                            {% if community.denomination == 'other' and community.denomination_other %}
                            ({{ community.denomination_other }})
                            {% endif %}
                        </li>
                        {% endif %}
                        
                        {% if community.address %}
                        <li class="mb-2">
                            <strong>üè† Adres:</strong><br>
                            {{ community.address }}
                        </li>
                        {% endif %}
                    </ul>
                    
                    <hr>

                    <h6>Kontakt</h6>
                    <ul class="list-unstyled small">
                        {% if community.contact_email %}
                        <li class="mb-2">
                            <strong>üìß Email:</strong><br>
                            <a href="mailto:{{ community.contact_email }}">{{ community.contact_email }}</a>
                        </li>
                        {% endif %}
                        
                        {% if community.contact_phone %}
                        <li class="mb-2">
                            <strong>üìû Telefon:</strong><br>
                            {{ community.contact_phone }}
                        </li>
                        {% endif %}
                        
                        {% if community.website %}
                        <li class="mb-2">
                            <strong>üåê Strona WWW:</strong><br>
                            <a href="{{ community.website }}" target="_blank" rel="noopener">
                                Odwied≈∫ stronƒô
                            </a>
                        </li>
                        {% endif %}
                    </ul>
                    
                    {% if not community.contact_email and not community.contact_phone and not community.website %}
                    <p class="text-muted small mb-0">Brak danych kontaktowych.</p>
                    {% endif %}
                </div>
            </div>
            
            <!-- Przyciski zarzƒÖdzania (dla owner/admin/leader) -->
            {% if user.is_authenticated and is_member %}
                {% if user_membership.role in 'owner,admin,leader' %}
                <div class="card mb-3">
                    <div class="card-body">
                        <h6 class="card-title">ZarzƒÖdzanie</h6>
                        <a href="{% url 'communities:community_manage' community.pk %}" 
                        class="btn btn-primary w-100 mb-2">
                            ‚öôÔ∏è ZarzƒÖdzaj wsp√≥lnotƒÖ
                        </a>
                        <a href="{% url 'communities:community_edit' community.pk %}" 
                        class="btn btn-outline-primary w-100">
                            ‚úèÔ∏è Edytuj profil
                        </a>
                    </div>
                </div>
                {% endif %}
            {% endif %}     

            <!-- Karta cz≈Çonkostwa - przyciski Do≈ÇƒÖcz/Opu≈õƒá -->
            <div class="card">
                <div class="card-body">
                    <h6 class="card-title">Cz≈Çonkostwo</h6>
                    
                    {% if user.is_authenticated %}
                        <!-- U≈ºytkownik ZALOGOWANY -->
                        
                        {% if is_member %}
                            <!-- Jest cz≈Çonkiem -->
                            <div class="alert alert-success mb-3">
                                <strong>‚úì Jeste≈õ cz≈Çonkiem tej wsp√≥lnoty</strong>
                                {% if user_membership.role != 'member' %}
                                <br>
                                <span class="badge bg-info mt-1">{{ user_membership.get_role_display }}</span>
                                {% endif %}
                            </div>
                            
                            {% if can_leave %}
                                <!-- Mo≈ºe opu≈õciƒá (nie jest owner/admin) -->
                                <form method="post" action="{% url 'communities:leave_community' community.pk %}" 
                                    onsubmit="return confirm('Czy na pewno chcesz opu≈õciƒá tƒô wsp√≥lnotƒô?');">
                                    {% csrf_token %}
                                    <button type="submit" class="btn btn-outline-danger w-100">
                                        Opu≈õƒá wsp√≥lnotƒô
                                    </button>
                                </form>
                                <small class="text-muted d-block mt-2">
                                    Mo≈ºesz wr√≥ciƒá w ka≈ºdej chwili
                                </small>
                            {% else %}
                                <!-- Nie mo≈ºe opu≈õciƒá (owner/admin) -->
                                <p class="text-muted small mb-0">
                                    Jako {{ user_membership.get_role_display }} nie mo≈ºesz opu≈õciƒá wsp√≥lnoty. 
                                    Skontaktuj siƒô z innym administratorem je≈õli chcesz przekazaƒá uprawnienia.
                                </p>
                            {% endif %}
                            
                        {% else %}
                            <!-- NIE jest cz≈Çonkiem - poka≈º przycisk "Do≈ÇƒÖcz" -->
                            <p class="mb-3">Do≈ÇƒÖcz aby uczestniczyƒá w ≈ºyciu wsp√≥lnoty</p>
                            <form method="post" action="{% url 'communities:join_community' community.pk %}">
                                {% csrf_token %}
                                <button type="submit" class="btn btn-success w-100">
                                    ‚ûï Do≈ÇƒÖcz do wsp√≥lnoty
                                </button>
                            </form>
                        {% endif %}
                        
                    {% else %}
                        <!-- U≈ºytkownik NIEZALOGOWANY -->
                        <div class="alert alert-info">
                            <strong>Chcesz do≈ÇƒÖczyƒá?</strong>
                            <p class="mb-2 small">Zaloguj siƒô lub zarejestruj aby do≈ÇƒÖczyƒá do tej wsp√≥lnoty.</p>
                        </div>
                        
                        <a href="{% url 'account_login' %}?next={{ request.path }}" 
                        class="btn btn-primary w-100 mb-2">
                            Zaloguj siƒô
                        </a>
                        <a href="{% url 'account_signup' %}?next={{ request.path }}" 
                        class="btn btn-outline-primary w-100">
                            Zarejestruj siƒô
                        </a>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>
{% endblock %}



