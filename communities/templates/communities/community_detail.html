{% extends 'communities/base.html' %}

{% block title %}{{ community.name }}{% endblock %}

{% block content %}
<div class="row">
    <div class="col-md-8">
        {% if community.photo_url %}
        <img src="{{ community.photo_url }}" class="img-fluid rounded mb-4" alt="{{ community.name }}">
        {% endif %}
        
        <h1>{{ community.name }}</h1>
        <p class="lead">{{ community.description }}</p>
        
        <div class="mb-3">
            {% for tag in community.tags.all %}
            <span class="badge bg-primary">{{ tag.name }}</span>
            {% endfor %}
        </div>
        
        <hr>
        
        <h3>O wspólnocie</h3>
        <p>{{ community.full_description|default:"Brak szczegółowego opisu." }}</p>
        
        <h3 class="mt-4">Członkowie ({{ members.count }})</h3>
        <ul class="list-group">
            {% for membership in members %}
            <li class="list-group-item">
                {{ membership.person.person_profile.first_name }} 
                {% if membership.role != 'member' %}
                <span class="badge bg-info">{{ membership.get_role_display }}</span>
                {% endif %}
            </li>
            {% empty %}
            <li class="list-group-item">Brak członków.</li>
            {% endfor %}
        </ul>
    </div>
    
    <div class="col-md-4">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">Informacje kontaktowe</h5>
                <p><strong>Miasto:</strong> {{ community.city }}</p>
                {% if community.parish %}
                <p><strong>Parafia:</strong> {{ community.parish }}</p>
                {% endif %}
                {% if community.denomination %}
                <p><strong>Denominacja:</strong> {{ community.get_denomination_display }}</p>
                {% endif %}
                {% if community.contact_email %}
                <p><strong>Email:</strong> <a href="mailto:{{ community.contact_email }}">{{ community.contact_email }}</a></p>
                {% endif %}
                {% if community.website %}
                <p><strong>Strona WWW:</strong> <a href="{{ community.website }}" target="_blank">Odwiedź</a></p>
                {% endif %}
                
                <hr>
                            
            <!-- SEKCJA CZŁONKOSTWA - NOWA LOGIKA -->
            
            {% if user.is_authenticated %}
                <!-- Użytkownik ZALOGOWANY -->
                
                {% if is_member %}
                    <!-- Jest członkiem -->
                    <div class="alert alert-success mb-3">
                        <strong>✓ Jesteś członkiem tej wspólnoty</strong>
                        {% if user_membership.role != 'member' %}
                        <br>
                        <span class="badge bg-info mt-1">{{ user_membership.get_role_display }}</span>
                        {% endif %}
                    </div>
                    
                    {% if can_leave %}
                        <!-- Może opuścić (nie jest owner/admin) -->
                        <form method="post" action="{% url 'communities:leave_community' community.pk %}" 
                            onsubmit="return confirm('Czy na pewno chcesz opuścić tę wspólnotę?');">
                            {% csrf_token %}
                            <button type="submit" class="btn btn-outline-danger w-100">
                                Opuść wspólnotę
                            </button>
                        </form>
                        <small class="text-muted d-block mt-2">
                            Możesz wrócić w każdej chwili
                        </small>
                    {% else %}
                        <!-- Nie może opuścić (owner/admin) -->
                        <p class="text-muted small mb-0">
                            Jako {{ user_membership.get_role_display }} nie możesz opuścić wspólnoty. 
                            Skontaktuj się z administratorem jeśli chcesz przekazać uprawnienia.
                        </p>
                    {% endif %}
                    
                {% else %}
                    <!-- NIE jest członkiem - pokaż przycisk "Dołącz" -->
                    <form method="post" action="{% url 'communities:join_community' community.pk %}">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-success w-100">
                            ➕ Dołącz do wspólnoty
                        </button>
                    </form>
                    <small class="text-muted d-block mt-2">
                        Dołącz aby uczestniczyć w życiu wspólnoty
                    </small>
                {% endif %}
                
            {% else %}
                <!-- Użytkownik NIEZALOGOWANY -->
                <div class="alert alert-info">
                    <strong>Chcesz dołączyć?</strong>
                    <p class="mb-2 small">Zaloguj się lub zarejestruj aby dołączyć do tej wspólnoty.</p>
                </div>
                
                <a href="{% url 'account_login' %}?next={{ request.path }}" class="btn btn-primary w-100 mb-2">
                    Zaloguj się
                </a>
                <a href="{% url 'account_signup' %}?next={{ request.path }}" class="btn btn-outline-primary w-100">
                    Zarejestruj się
                </a>
            {% endif %}
        
                
                <!-- <button class="btn btn-success w-100">Dołącz do wspólnoty</button>
                <small class="text-muted d-block mt-2">Wymaga zalogowania</small> -->
            <!-- </div> -->
        </div>
    </div>
</div>
{% endblock %}